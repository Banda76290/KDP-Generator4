Contexte : le déploiement échoue pendant la phase migration base. L’UI de logs se crashe avec TypeError: Cannot read properties of undefined (reading 'join') dans _next/static/chunks/framework-*.js. Code erreur Replit AI : 96485bd4ab384bc5bbfa1d49cca9280b.
Objectif : trouver la vraie erreur de migration et déployer.

Instructions pas-à-pas pour l’agent :

Ouvre package.json et dis-moi si le projet utilise Prisma ou Drizzle.

Liste les variables d’environnement de l’environnement de déploiement et vérifie la présence de :

Prisma : DATABASE_URL, DIRECT_URL, SHADOW_DATABASE_URL

Drizzle : l’URL de connexion utilisée par drizzle.config.*
Ne loggue pas les secrets en clair, mais confirme si elles existent et si elles semblent être des URL PostgreSQL valides.

Si Prisma :

Montre la version npx prisma -v, le chemin de schema.prisma, et la liste prisma/migrations.

Exécute npx prisma migrate deploy --schema=./prisma/schema.prisma --verbose.

Si erreur liée à PgBouncer/pooled connection, configure directUrl dans schema.prisma, définit DIRECT_URL sur la connexion directe (sans pool), garde DATABASE_URL pour la connexion poolée, ajoute sslmode=require si nécessaire, puis relance migrate deploy.

Si la base contient déjà des tables et qu’il n’y a pas d’historique, fais un baseline :

identifie la dernière migration,

exécute npx prisma migrate resolve --applied <nom_dossier_migration> et relance migrate deploy.

Si Drizzle :

Vérifie drizzle.config.* et l’URL utilisée par drizzle-kit.

Exécute npx drizzle-kit push --verbose.

Si ça échoue, teste avec une connexion directe (non poolée) spécifiquement pour drizzle-kit, puis réessaie.

Vérifie que l’URL DB inclut sslmode=require si le provider le demande.

Donne un résumé : quelles variables manquaient ou étaient mal pointées, quelle commande a finalement passé, et colle l’extrait d’erreur utile issu de la CLI (pas l’erreur Next.js du viewer).

Ré-exécute le Deploy complet après correction.

Si le viewer de logs crashe encore, exporte les logs bruts et indique le chemin ou colle les 100 dernières lignes pertinentes.